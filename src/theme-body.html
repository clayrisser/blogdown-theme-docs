<dom-module id="theme-body">
  <template>
    <style>
      :host {
        width: 100%;
      }
      body {
        display: block;
        font-family: "Lato","proxima-nova","Helvetica Neue",Arial,sans-serif;
        font-weight: normal;
        min-height: 100%;
        overflow-x: hidden;
        margin: 0;
        color: #404040;
      }
      paper-menu {
        margin-top: 64px;
        height: 100%;
      }
      app-drawer-layout {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      app-toolbar {
        background-color: red;
        color: var(--paper-toolbar-color);
        -webkit-box-shadow: 0px 0px 10px 2px rgba(0,0,0,0.75);
        -moz-box-shadow: 0px 0px 10px 2px rgba(0,0,0,0.75);
        box-shadow: 0px 0px 10px 2px rgba(0,0,0,0.75);
      }
      .main-content {
        margin: 0;
        padding: 0;
      }
      .loading-bar {
        width: 100%;
        --paper-progress-height: 64px;
        --paper-progress-container-color: rgba(255, 255, 255, 0);
        --paper-progress-active-color: var(--paper-progress-secondary-color);
      }
      .title-section {
        display: inline-flex;
        align-items: center;
      }
      .title-section a {
        color: var(--paper-toolbar-color);
        text-decoration: none;
        margin-left: 10px;
      }
      .title-section a:hover {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      .social-accounts {
        display: inline-flex;
        justify-content: flex-end;
        flex: 1;
      }
      .title-section {
        flex: 1;
      }
      .toolbar-content {
        z-index: 0;
        display: inline-flex;
        width: 100%;
        height: 64px;
        margin: 0px;
        padding: 0px;
        align-items: center;
      }
      .social-account {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      .social-account:hover {
        color: var(--paper-toolbar-color);
        text-decoration: none;
      }
      .menu-item a {
        text-decoration: inherit;
        color: inherit;
        cursor: pointer;
      }
      .menu-item paper-item {
        font-weight: inherit;
      }
      .toast {
        cursor: pointer;
      }
      #toastError {
        --paper-toast-background-color: red;
      }
      #toastWarn {
        --paper-toast-background-color: orange;
      }
      #toastInfo {
        --paper-toast-background-color: green;
      }
      #drawer {
        padding-bottom: 3em;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 300px;
        overflow-x: hidden;
        overflow-y: hidden;
        min-height: 100%;
        background: #343131;
        z-index: 200;
      }
      #sideMenu {
        width: 320px;
        position: relative;
        overflow-x: hidden;
        overflow-y: scroll;
        height: 100%;
      }

      .grid-for-nav {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      .nav-side-shift {
        padding-bottom: 3em;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 300px;
        overflow-x: hidden;
        overflow-y: hidden;
        min-height: 100%;
        background-color: #343131;
        z-index: 200;
      }
      .side-scroll {
        width: 320px;
        position: relative;
        overflow-x: hidden;
        overflow-y: scroll;
        height: 100%;
      }
      .nav-search {
        width: 300px;
        z-index: 200;
        background-color: #2980B9;
        text-align: center;
        padding: .809em;
        display: block;
        color: #fcfcfc;
        margin-bottom: .809em;
      }
      .nav-search a {
        color: #fcfcfc;
        font-size: 100%;
        font-weight: bold;
        display: inline-block;
        padding: 4px 6px;
        margin-bottom: .809em;
      }
      .logo {
        display: block;
        margin: 0 auto;
        height: auto;
        width: auto;
        border-radius: 0;
        max-width: 100%;
        background: transparent;
      }
      .form {
        width: 95%;
        display: block;
        margin-right: 10px;
        text-align: center;
        box-sizing: border-box;
        color: #fcfcfc;
        font-size: 100%;
        font-weight: normal;
        font-family: "Lato","proxima-nova","Helvetica Neue",Arial,sans-serif;
      }
      .search-form input {
        width: 80%;
        border-radius: 50px;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-color: #2472a4;
        box-shadow: inset 0 1px 3px #ddd;
        font-size: 80%;
        display: inline-block;
        transition: border 0.3s linear;
        margin-left: -15px;
        margin-right: 10px;
      }
      .menu-vertical {
        width: 300px;
        font-weight: normal;
      }
      .section-title {
        height: 32px;
        line-height: 32px;
        padding: 0 1.618em;
        margin-bottom: 0;
        display: block;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 80%;
        color: #555;
        white-space: nowrap;
        margin: 0;
      }
      .section-title a {
        margin: 0;
      }
      .menu-vertical a {
        line-height: 18px;
        padding: .4045em 1.618em;
        display: block;
        position: relative;
        font-size: 90%;
        text-decoration: none;
        cursor: pointer;
        color: inherit;
      }
      .nav-content-wrap {
        margin-left: 300px;
        background-color: rgba(0, 0, 0, 0.05);
        min-height: 100%;
        height: 100%;
        display: block;
        box-sizing: border-box;
      }
      .nav-content {
        padding: 1.618em 3.236em;
        min-height: 100%;
        height: 100%;
        max-width: 800px;
        margin: auto;
        margin-left: 0;
        background-color: #ffffff;
      }
      .breadcrumbs {
        margin: 0;
        padding: 0;
        list-style: none;
        list-style-image: none;
      }
      .breadcrumbs li a {
        display: inline-block;
        padding-right: 5px;
      }
      a:visited {
        color: #9B59B6;
      }
      a {
        color: #2980B9;
        text-decoration: none;
        cursor: pointer;
      }
      hr {
        display: block;
        height: 1px;
        border: 0;
        border-top: 1px solid #e1e4e5;
        margin: 24px 0;
        padding: 0;
      }
      .menu-vertical ul {
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .menu-post a {
        line-height: 18px;
        padding: .4045em 1.618em;
        display: block;
        position: relative;
        font-size: 90%;
        color: #b3b3b3;
      }
      .menu-post a:hover {
        background-color: #4e4a4a;
      }
      .breadcrumbs li {
        display: inline-block;
      }
    </style>
    <style include="iron-positioning"></style>


    <app-drawer-layout fullbleed narrow="{{narrow}}">
      <nav class="nav-side-shift">
        <div class="side-scroll">
          <div class="nav-search">
            <a href="#">
              <img src="thingdown-logo" class="logo" alt="Logo here">
            </a>
            <div>
              <form id="search-form" class="search-form">
                <input type="text" placeholder="Search documentation">
              </form>
          </div>
        </div>
        <div class="menu-vertical" selected="[[selectedMenuItem]]">
          <template is="dom-repeat" items="[[menuItems]]" as="menuItem">
            <p class="section-title">
              <span>
                [[menuItem.title]]
              </span>
            </p>
            <ul>
              <template is="dom-repeat" items="[[getPostsForTaxonomy(menuItem.slug)]]" as="post">
                <li class="menu-post">
                  <a href="/[[menuItem.slug]]/[[post.slug]]">[[post.title]]</a></li>
              </template>
            </ul>
          </template>
        </div>
      </nav>
      <section class="nav-content-wrap">
        <div class="nav-content">
          <div>
            <div role="navigation" aria-label="breadcrumbs navigation">
              <ul class="breadcrumbs">
                <li>
                  <a href="/">Docs</a>
                   &nbsp;»
                 </li>
                 <li>[[path]]</li>
              </ul>
              <hr>
            </div>
            <div role="main">
              <div class="main-content">
                <blogdown-content></blogdown-content>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!--<app-drawer id="drawer">
        <paper-menu id="sideMenu" selected="[[selectedMenuItem]]">
          <template is="dom-repeat" items="[[menuItems]]" as="menuItem">
            <div class="menu-item">
              <a href="/[[menuItem.slug]]">
                <paper-item on-click="closeDrawer" id="[[menuItem.slug]]">
                  [[menuItem.title]]
                </paper-item>
              </a>
            </div>
          </template>
        </paper-menu>
      </app-drawer>-->
    </app-drawer-layout>

    <!--<app-toolbar class="fixed-top" elevation="1">
      <div class="fixed-top">
        <paper-progress
            class="loading-bar"
            value="[[progress]]"
            indeterminate="[[loading]]">
        </paper-progress>
      </div>
      <div class="toolbar-content">
        <div class="title-section">
          <div class="drawer-button">
            <paper-icon-button
                class="drawer-button"
                icon="menu"
                on-click="toggleDrawer"
                hidden=[[!narrow]]>
            </paper-icon-button>
          </div>
          <a href="/" on-click="closeDrawer">[[settings.title]]</a>
        </div>
        <div class="social-accounts">
          <template is="dom-repeat" items=[[socialAccounts]] as="socialAccount">
            <a class="social-account"
               href="[[socialAccount.url]]"
               target="_blank">
              <paper-icon-button icon="fa:[[socialAccount.type]]">
              </paper-icon-button>
            </a>
          </template>
        </div>
      </div>
    </app-toolbar>-->

    <div class="toast-hide" on-click="hideToast">
      <paper-toast id="toastInfo" class="toast" text="[[notification.message]]" duration="[[themeSettings.toastDuration]]"></paper-toast>
      <paper-toast id="toastWarn" class="toast" text="[[notification.message]]" duration="[[themeSettings.toastDuration]]"></paper-toast>
      <paper-toast id="toastError" class="toast" text="[[notification.message]]" duration="[[themeSettings.toastDuration]]"></paper-toast>
    </div>

  </template>
  <script>
    class ThemeBody {
      beforeRegister() {
        this.is = 'theme-body';

        this.actions = {
          isNarrow: (narrow) => {
            return (dispatch) => {
              dispatch({
                type: IS_NARROW,
                payload: narrow
              });
            };
          },
          path: (path) => {
            return (dispatch) => {
              dispatch({
                type: IS_NARROW,
                payload: path
              });
            };
          }
        };

        this.properties = {
          metaLoading: {
            type: Array,
            statePath: 'meta.loading',
            observer: 'progressChanged'
          },
          metaProgress: {
            type: Number,
            statePath: 'meta.progress',
            observer: 'progressChanged'
          },
          notifications: {
            type: Array,
            statePath: 'notifications',
            observer: 'notificationsChanged'
          },
          meta: {
            type: Object,
            statePath: 'meta'
          },
          pages: {
            type: [],
            statePath: 'pages'
          },
          taxonomies: {
            type: [],
            statePath: 'taxonomies'
          },
          route: {
            type: Object,
            statePath: 'route',
            observer: 'routeChanged'
          },
          path: {
            type: String
          },
          settings: {
            type: Object,
            statePath: 'settings'
          },
          meta: {
            type: Object,
            statePath: 'meta'
          },
          narrow: {
            type: Boolean,
            observer: 'narrowChanged'
          },
          animationConfig: {
            value: function() {
              return {
                entry: {
                  name: 'scale-up-animation',
                  node: this
                },
                exit: {
                  name: 'fade-out-animation',
                  node: this
                }
              };
            }
          }
        };
      }

      get behaviors() {
        return [
          BodyBehavior,
          Polymer.NeonAnimationRunnerBehavior,
          ReduxActionsBehavior,
          ReduxStateBehavior
        ];
      }

      getCurrentTitle() {
        console.log('Current title: ' + document.getElementById("title"));
        return document.getElementById("title");
      }

      getPostsForTaxonomy(taxonomy) {
        console.log('Posts for taxonomy!');
        var posts = this.taxonomies[taxonomy];
        if(!posts)
          return [];
        return posts;
      }

      getPath() {
        console.log('GET PATH!!!!!');
        if(this.route && this.route.slugs) {
          var path = this.route.slugs['parent'];
          if(this.route.slugs['child']) {
            path += ' » ' + this.route.slugs['child'];
          }

          console.log('PATH: %s', path);
          return path;
        }
        return 'Test';
      }

      ready() {
        this.set('themeSettings', _.assign({
          toastDuration: 5000
        }, app.getThemeSettings()));
        this.set('indeterminateLoading', true);
        this.set('socialAccounts', []);
        this.set('menuItems', []);
        this.set('path', this.getPath());
        this.loadMenuItems();
        this.loadSocialAccounts();
        console.log('Current title: ' + document.getElementById("title"));
      }

      loadMenuItems() {
        _.each(this.pages, (page) => {
          if (page.addToMenu) {
            this.push('menuItems', {
              title: page.title,
              slug: page.slug
            });
          }
        });
      }

      loadSocialAccounts() {
        _.each(this.themeSettings.socialAccounts, (socialAccount, key) => {
          this.push('socialAccounts', {
            type: key,
            url: socialAccount
          });
        });
      }

      toggleDrawer() {
        this.$.drawer.toggle();
      }

      closeDrawer() {
        if (this.narrow) this.$.drawer.close();
      }

      narrowChanged() {
        this.dispatch('isNarrow', this.narrow);
      }

      routeChanged() {
        console.log('ROUTE CHANGED');
        this.set('path', this.getPath());
        //this.dispatch('path', this.getPath());
      }

      notificationsChanged() {
        this.hideToast();
        if (this.meta && this.meta.appLoaded) {
          this.set('notification', this.notifications[this.notifications.length - 1]);
          switch (this.notification.type) {
            case 'error':
              this.$.toastError.open();
              break;
            case 'warn':
              this.$.toastWarn.open();
              break;
            default:
              this.$.toastInfo.open();
              break;
          }
        }
      }

      hideToast() {
        this.$.toastError.close();
        this.$.toastWarn.close();
        this.$.toastInfo.close();
      }

      progressChanged() {
        if (this.metaLoading.length > 0) {
          this.set('loading', true);
          this.set('progress', 0);
        } else if (this.metaProgress > 0) {
          this.set('loading', false);
          this.set('progress', this.metaProgress);
        } else {
          this.set('loading', false);
          this.set('progress', 0);
        }
      }
    }
    Polymer(ThemeBody);
  </script>
</dom-module>
